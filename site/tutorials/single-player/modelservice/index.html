<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        
        
        <link rel="shortcut icon" href="../../../img/favicon.ico">
        <title>Build the Single Player Model Service - Simpl Documentation</title>
        <link href="../../../css/bootstrap-custom.min.css" rel="stylesheet">
        <link href="../../../css/font-awesome-4.5.0.css" rel="stylesheet">
        <link href="../../../css/base.css" rel="stylesheet">
        <link rel="stylesheet" href="../../../css/highlight.css">
        <link href="../../../pygments.css" rel="stylesheet">
        <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
        <!--[if lt IE 9]>
            <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
            <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
        <![endif]-->

        <script src="../../../js/jquery-1.10.2.min.js"></script>
        <script src="../../../js/bootstrap-3.0.3.min.js"></script>
        <script src="../../../js/highlight.pack.js"></script> 
    </head>

    <body>

        <div class="navbar navbar-default navbar-fixed-top" role="navigation">
    <div class="container">

        <!-- Collapsed navigation -->
        <div class="navbar-header">
            <!-- Expander button -->
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="../../..">Simpl Documentation</a>
        </div>

        <!-- Expanded navigation -->
        <div class="navbar-collapse collapse">
                <!-- Main navigation -->
                <ul class="nav navbar-nav">
                    <li >
                        <a href="../../..">Welcome to Simpl</a>
                    </li>
                    <li >
                        <a href="../../../overview/">Overview</a>
                    </li>
                    <li class="dropdown">
                        <a href="#" class="dropdown-toggle" data-toggle="dropdown">Getting Started <b class="caret"></b></a>
                        <ul class="dropdown-menu">
                            
<li >
    <a href="../../../getting_started/">Running a Simpl Simulation</a>
</li>
                        </ul>
                    </li>
                    <li class="dropdown active">
                        <a href="#" class="dropdown-toggle" data-toggle="dropdown">Tutorials <b class="caret"></b></a>
                        <ul class="dropdown-menu">
                            
<li >
    <a href="../">Single Player Example</a>
</li>
                            
<li class="active">
    <a href="./">Build the Single Player Model Service</a>
</li>
                            
<li >
    <a href="../frontend/">Build the Single Player Front End</a>
</li>
                        </ul>
                    </li>
                    <li class="dropdown">
                        <a href="#" class="dropdown-toggle" data-toggle="dropdown">Services <b class="caret"></b></a>
                        <ul class="dropdown-menu">
                            
<li >
    <a href="../../../services/simpl-users/">simpl-users</a>
</li>
                            
<li >
    <a href="../../../services/Simpl-Games-API/">Simpl-Games-API</a>
</li>
                            
  <li class="dropdown-submenu">
    <a href="#">modelservice</a>
    <ul class="dropdown-menu">
            
  <li class="dropdown-submenu">
    <a href="#">Games</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="../../../services/modelservice/games/">Scopes</a>
</li>
            
<li >
    <a href="../../../services/modelservice/traversing/">Traversing Scopes</a>
</li>
            
<li >
    <a href="../../../services/modelservice/scopemanager/">Scope Manager</a>
</li>
    </ul>
  </li>
            
<li >
    <a href="../../../services/modelservice/running/">Running</a>
</li>
            
<li >
    <a href="../../../services/modelservice/settings/">Setting</a>
</li>
            
<li >
    <a href="../../../services/modelservice/simpl/">Simpl client</a>
</li>
            
<li >
    <a href="../../../services/modelservice/webhooks/">Webhooks</a>
</li>
    </ul>
  </li>
                            
  <li class="dropdown-submenu">
    <a href="#">simpl-react</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="../../../services/simpl-react/overview/">Overview</a>
</li>
            
<li >
    <a href="../../../services/simpl-react/actions/">Actions</a>
</li>
    </ul>
  </li>
                        </ul>
                    </li>
                </ul>

            <ul class="nav navbar-nav navbar-right">
                <li>
                    <a href="#" data-toggle="modal" data-target="#mkdocs_search_modal">
                        <i class="fa fa-search"></i> Search
                    </a>
                </li>
                    <li >
                        <a rel="next" href="../">
                            <i class="fa fa-arrow-left"></i> Previous
                        </a>
                    </li>
                    <li >
                        <a rel="prev" href="../frontend/">
                            Next <i class="fa fa-arrow-right"></i>
                        </a>
                    </li>
            </ul>
        </div>
    </div>
</div>

        <div class="container">
                <div class="col-md-3"><div class="bs-sidebar hidden-print affix well" role="complementary">
    <ul class="nav bs-sidenav">
        <li class="main active"><a href="#building-the-model-service-implementation">Building the Model Service implementation</a></li>
            <li><a href="#prerequisites">Prerequisites</a></li>
            <li><a href="#installation">Installation</a></li>
            <li><a href="#implementation">Implementation</a></li>
    </ul>
</div></div>
                <div class="col-md-9" role="main">

<h1 id="building-the-model-service-implementation">Building the Model Service implementation</h1>
<h2 id="prerequisites">Prerequisites</h2>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>This tutorial assumes you have <a href="../../../getting_started/">Games API service</a> running (http://localhost:8100/) on a Vagrant box you have provisioned.  Please open up an additional terminal window before continuing.</p>
</div>
<h2 id="installation">Installation</h2>
<p>First, log into Vagrant and create a new virtualenv called 'calc-model':</p>
<div class="codehilite"><pre><span></span>$ vagrant ssh
$ mkvirtualenv calc-model
</pre></div>


<p>Install Django</p>
<div class="codehilite"><pre><span></span>$ pip install <span class="nv">Django</span><span class="o">==</span><span class="m">1</span>.11.11
</pre></div>


<p>Change to the projects folder:</p>
<div class="codehilite"><pre><span></span>$ <span class="nb">cd</span> projects
</pre></div>


<p>Create a Django project folder and rename it to serve as a git repository</p>
<div class="codehilite"><pre><span></span>$ django-admin startproject calc_model
$ mv calc_model calc-model
</pre></div>


<p>Change to the project folder:</p>
<div class="codehilite"><pre><span></span>$ <span class="nb">cd</span> calc-model
$ add2virtualenv .
</pre></div>


<p>Create a <code>requirements.txt</code> file that installs the simpl-modelservice and unit testing apps:</p>
<div class="codehilite"><pre><span></span>https://github.com:simplworld/simpl-modelservice/repository/archive.zip

# tests
pytest==3.1.3
pytest-cov==2.5.1
pytest-django==3.1.2
django-test-plus==1.0.22
</pre></div>


<p>Install these requirements along with their dependencies:</p>
<div class="codehilite"><pre><span></span>$ <span class="nv">PIP_PROCESS_DEPENDENCY_LINKS</span><span class="o">=</span><span class="m">1</span> pip install -r requirements.txt
</pre></div>


<p>Please note, if <code>DJANGO_SETTINGS_MODULE</code> is leftover from a previous session, you may need to unset it:</p>
<div class="codehilite"><pre><span></span>$ <span class="nb">unset</span> DJANGO_SETTINGS_MODULE
</pre></div>


<p>Create a django app that will contain your game logic:</p>
<div class="codehilite"><pre><span></span>$ ./manage.py startapp game
</pre></div>


<p>Add the following to your <code>INSTALLED_APPS</code> in <code>calc_model/settings.py</code>:</p>
<div class="codehilite"><pre><span></span><span class="n">INSTALLED_APPS</span> <span class="o">+=</span> <span class="p">[</span>
    <span class="o">...</span>

    <span class="s1">&#39;modelservice&#39;</span><span class="p">,</span>
    <span class="s1">&#39;rest_framework&#39;</span><span class="p">,</span>

    <span class="s1">&#39;game&#39;</span><span class="p">,</span>
<span class="p">]</span>

<span class="n">CALLBACK_URL</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;CALLBACK_URL&#39;</span><span class="p">,</span> <span class="s1">&#39;http://{hostname}:{port}/callback&#39;</span><span class="p">)</span>

<span class="n">SIMPL_GAMES_URL</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;SIMPL_GAMES_URL&#39;</span><span class="p">,</span> <span class="s1">&#39;http://localhost:8100/apis&#39;</span><span class="p">)</span>

<span class="n">SIMPL_GAMES_AUTH</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;simpl@simpl.world&#39;</span><span class="p">,</span> <span class="s1">&#39;simpl&#39;</span><span class="p">)</span>

<span class="n">ROOT_TOPIC</span> <span class="o">=</span> <span class="s1">&#39;world.simpl.sims.calc&#39;</span>
</pre></div>


<p>It's highly recommended that you set a <code>'users'</code> cache. Since the modelservice will run single-threaded, you can take advantage of the <code>locmem</code> backend:</p>
<div class="codehilite"><pre><span></span>CACHES = {
    &#39;default&#39;: {
        &#39;BACKEND&#39;: &#39;django.core.cache.backends.dummy.DummyCache&#39;,
    },
    &#39;users&#39;: {
        &#39;BACKEND&#39;: &#39;django.core.cache.backends.locmem.LocMemCache&#39;,
        &#39;LOCATION&#39;: &#39;users&#39;,
    }
}
</pre></div>


<h2 id="implementation">Implementation</h2>
<p>For simplicity, we're going to create a single player Game in which each player has a Scenario that can advance multiple periods.</p>
<p>In your <code>game</code> app module, define our model in <code>model.py</code>:</p>
<div class="codehilite"><pre><span></span><span class="kr">class</span> <span class="nx">Model</span><span class="p">(</span><span class="nx">object</span><span class="p">)</span><span class="o">:</span>
    <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    The model adds an operand to the previous total and returns the result.</span>
<span class="s2">    &quot;&quot;&quot;</span>

    <span class="nx">def</span> <span class="nx">step</span><span class="p">(</span><span class="nx">self</span><span class="p">,</span> <span class="nx">operand</span><span class="p">,</span> <span class="nx">prev_total</span><span class="o">=</span><span class="mf">0.0</span><span class="p">)</span><span class="o">:</span>
        <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        Parameters:</span>
<span class="s2">            operand - current period&#39;s decision</span>
<span class="s2">            prev_total - the calculated total from the previous period</span>
<span class="s2">        Returns new total</span>
<span class="s2">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nx">operand</span> <span class="o">+</span> <span class="nx">prev_total</span>
</pre></div>


<p>In your <code>game</code> app module, add a unit test directory <code>tests</code> and a model unit test <code>tests/test_model.py</code>:</p>
<div class="codehilite"><pre><span></span><span class="kn">import</span> <span class="nn">pytest</span>
<span class="kn">from</span> <span class="nn">test_plus.test</span> <span class="kn">import</span> <span class="n">TestCase</span>

<span class="kn">from</span> <span class="nn">game.model</span> <span class="kn">import</span> <span class="n">Model</span>


<span class="k">class</span> <span class="nc">ModelTestCase</span><span class="p">(</span><span class="n">TestCase</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">m</span> <span class="o">=</span> <span class="n">Model</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">test_create</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">m</span> <span class="o">=</span> <span class="n">Model</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertNotEqual</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">test_first_step</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">m</span> <span class="o">=</span> <span class="n">Model</span><span class="p">()</span>
        <span class="n">total</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">step</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEquals</span><span class="p">(</span><span class="n">total</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">test_increase_step</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">m</span> <span class="o">=</span> <span class="n">Model</span><span class="p">()</span>
        <span class="n">total</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">step</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEquals</span><span class="p">(</span><span class="n">total</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">test_decrease_step</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">m</span> <span class="o">=</span> <span class="n">Model</span><span class="p">()</span>
        <span class="n">total</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">step</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="o">-</span><span class="mf">2.5</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEquals</span><span class="p">(</span><span class="n">total</span><span class="p">,</span> <span class="mf">2.5</span><span class="p">)</span>
</pre></div>


<p>Run your unit test:</p>
<div class="codehilite"><pre><span></span>$ <span class="nb">export</span> <span class="nv">DJANGO_SETTINGS_MODULE</span><span class="o">=</span>calc_model.settings
$ py.test
</pre></div>


<p>Create a management command that will create your game and initialize it with one run, a leader and 2 players.</p>
<p>Create a 'management' folder in the <code>game</code> folder and add an empty <code>__init__.py</code> file.</p>
<p>Create a 'commands' folder in the <code>management</code> folder  and add an empty <code>__init__.py</code> file.</p>
<p>Finally, create a <code>create_default_env.py</code> script in the 'commands' folder containing this code:</p>
<div class="codehilite"><pre><span></span><span class="kn">import</span> <span class="nn">djclick</span> <span class="kn">as</span> <span class="nn">click</span>

<span class="kn">from</span> <span class="nn">modelservice.simpl</span> <span class="kn">import</span> <span class="n">games_client</span>
<span class="kn">from</span> <span class="nn">modelservice.utils.asyncio</span> <span class="kn">import</span> <span class="n">coro</span>


<span class="k">def</span> <span class="nf">echo</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
    <span class="n">click</span><span class="o">.</span><span class="n">echo</span><span class="p">(</span>
        <span class="n">click</span><span class="o">.</span><span class="n">style</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">fg</span><span class="o">=</span><span class="s1">&#39;green&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;{0}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
    <span class="p">)</span>


<span class="n">async</span> <span class="k">def</span> <span class="nf">delete_default_run</span><span class="p">(</span><span class="n">api_session</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Delete default Run &quot;&quot;&quot;</span>
    <span class="n">echo</span><span class="p">(</span><span class="s1">&#39;Resetting the Calc game default run...&#39;</span><span class="p">,</span> <span class="s1">&#39; done&#39;</span><span class="p">)</span>
    <span class="n">runs</span> <span class="o">=</span> <span class="n">await</span> <span class="n">api_session</span><span class="o">.</span><span class="n">runs</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">game_slug</span><span class="o">=</span><span class="s1">&#39;calc&#39;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">run</span> <span class="ow">in</span> <span class="n">runs</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">run</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;default&#39;</span><span class="p">:</span>
            <span class="n">await</span> <span class="n">api_session</span><span class="o">.</span><span class="n">runs</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">run</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>


<span class="nd">@click.command</span><span class="p">()</span>
<span class="nd">@click.option</span><span class="p">(</span><span class="s1">&#39;--reset&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">is_flag</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
              <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Delete default game run and recreate it from scratch&quot;</span><span class="p">)</span>
<span class="nd">@coro</span>
<span class="n">async</span> <span class="k">def</span> <span class="nf">command</span><span class="p">(</span><span class="n">reset</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Create and initialize Calc game.</span>
<span class="sd">    Create a &quot;default&quot; Calc run.</span>
<span class="sd">    Set the run phase to &quot;Play&quot;.</span>
<span class="sd">    Add 1 leader (&quot;leader&quot;) to the run</span>
<span class="sd">    Add 2 players (&quot;s1&quot;, &quot;s2&quot;) to the run.</span>
<span class="sd">    Add a scenario and period 1 for each player.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">async</span> <span class="k">with</span> <span class="n">games_client</span> <span class="k">as</span> <span class="n">api_session</span><span class="p">:</span>

        <span class="c1"># Handle resetting the game</span>
        <span class="k">if</span> <span class="n">reset</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">click</span><span class="o">.</span><span class="n">confirm</span><span class="p">(</span>
                    <span class="s1">&#39;Are you sure you want to delete the default game run and recreate from scratch?&#39;</span><span class="p">):</span>
                <span class="n">await</span> <span class="n">delete_default_run</span><span class="p">(</span><span class="n">api_session</span><span class="p">)</span>

        <span class="c1"># Create a Game</span>
        <span class="n">game</span> <span class="o">=</span> <span class="n">await</span> <span class="n">api_session</span><span class="o">.</span><span class="n">games</span><span class="o">.</span><span class="n">get_or_create</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="s1">&#39;Calc&#39;</span><span class="p">,</span>
            <span class="n">slug</span><span class="o">=</span><span class="s1">&#39;calc&#39;</span>
        <span class="p">)</span>
        <span class="n">echo</span><span class="p">(</span><span class="s1">&#39;getting or creating game: &#39;</span><span class="p">,</span> <span class="n">game</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

        <span class="c1"># Create game Phases (&quot;Play&quot;)</span>
        <span class="n">play_phase</span> <span class="o">=</span> <span class="n">await</span> <span class="n">api_session</span><span class="o">.</span><span class="n">phases</span><span class="o">.</span><span class="n">get_or_create</span><span class="p">(</span>
            <span class="n">game</span><span class="o">=</span><span class="n">game</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
            <span class="n">name</span><span class="o">=</span><span class="s1">&#39;Play&#39;</span><span class="p">,</span>
            <span class="n">order</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">echo</span><span class="p">(</span><span class="s1">&#39;getting or creating phase: &#39;</span><span class="p">,</span> <span class="n">play_phase</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

        <span class="c1"># Add run with 2 players ready to play</span>
        <span class="n">run</span> <span class="o">=</span> <span class="n">await</span> <span class="n">add_run</span><span class="p">(</span><span class="n">game</span><span class="p">,</span> <span class="s1">&#39;default&#39;</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">play_phase</span><span class="p">,</span> <span class="n">api_session</span><span class="p">)</span>

        <span class="n">echo</span><span class="p">(</span><span class="s1">&#39;Completed setting up run: id=&#39;</span><span class="p">,</span> <span class="n">run</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>


<span class="n">async</span> <span class="k">def</span> <span class="nf">add_run</span><span class="p">(</span><span class="n">game</span><span class="p">,</span> <span class="n">run_name</span><span class="p">,</span> <span class="n">user_count</span><span class="p">,</span> <span class="n">phase</span><span class="p">,</span> <span class="n">api_session</span><span class="p">):</span>
    <span class="c1"># Create or get the Run</span>
    <span class="n">run</span> <span class="o">=</span> <span class="n">await</span> <span class="n">api_session</span><span class="o">.</span><span class="n">runs</span><span class="o">.</span><span class="n">get_or_create</span><span class="p">(</span>
        <span class="n">game</span><span class="o">=</span><span class="n">game</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
        <span class="n">name</span><span class="o">=</span><span class="n">run_name</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">echo</span><span class="p">(</span><span class="s1">&#39;getting or creating run: &#39;</span><span class="p">,</span> <span class="n">run</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

    <span class="c1"># Set run to phase</span>
    <span class="n">run</span><span class="o">.</span><span class="n">phase</span> <span class="o">=</span> <span class="n">phase</span><span class="o">.</span><span class="n">id</span>
    <span class="n">await</span> <span class="n">run</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
    <span class="n">echo</span><span class="p">(</span><span class="s1">&#39;setting run to phase: &#39;</span><span class="p">,</span> <span class="n">phase</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

    <span class="n">fac_user</span> <span class="o">=</span> <span class="n">await</span> <span class="n">api_session</span><span class="o">.</span><span class="n">users</span><span class="o">.</span><span class="n">get_or_create</span><span class="p">(</span>
        <span class="n">password</span><span class="o">=</span><span class="s1">&#39;leader&#39;</span><span class="p">,</span>
        <span class="n">first_name</span><span class="o">=</span><span class="s1">&#39;CALC&#39;</span><span class="p">,</span>
        <span class="n">last_name</span><span class="o">=</span><span class="s1">&#39;Leader&#39;</span><span class="p">,</span>
        <span class="n">email</span><span class="o">=</span><span class="s1">&#39;leader@calc.edu&#39;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">echo</span><span class="p">(</span><span class="s1">&#39;getting or creating user: &#39;</span><span class="p">,</span> <span class="n">fac_user</span><span class="o">.</span><span class="n">email</span><span class="p">)</span>

    <span class="n">fac_runuser</span> <span class="o">=</span> <span class="n">await</span> <span class="n">api_session</span><span class="o">.</span><span class="n">runusers</span><span class="o">.</span><span class="n">get_or_create</span><span class="p">(</span>
        <span class="n">user</span><span class="o">=</span><span class="n">fac_user</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
        <span class="n">run</span><span class="o">=</span><span class="n">run</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
        <span class="n">leader</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">echo</span><span class="p">(</span><span class="s1">&#39;getting or creating leader runuser for user: &#39;</span><span class="p">,</span> <span class="n">fac_user</span><span class="o">.</span><span class="n">email</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">user_count</span><span class="p">):</span>
        <span class="n">user_number</span> <span class="o">=</span> <span class="n">n</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="c1"># Add player to run</span>
        <span class="n">await</span> <span class="n">add_player</span><span class="p">(</span><span class="n">user_number</span><span class="p">,</span> <span class="n">run</span><span class="p">,</span> <span class="n">api_session</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">run</span>


<span class="n">async</span> <span class="k">def</span> <span class="nf">add_player</span><span class="p">(</span><span class="n">user_number</span><span class="p">,</span> <span class="n">run</span><span class="p">,</span> <span class="n">api_session</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Add player with name based on user_number to run with role&quot;&quot;&quot;</span>

    <span class="n">username</span> <span class="o">=</span> <span class="s1">&#39;s{0}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">user_number</span><span class="p">)</span>
    <span class="n">first_name</span> <span class="o">=</span> <span class="s1">&#39;Student{0}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">user_number</span><span class="p">)</span>
    <span class="n">email</span> <span class="o">=</span> <span class="s1">&#39;{0}@calc.edu&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">username</span><span class="p">)</span>

    <span class="n">user</span> <span class="o">=</span> <span class="n">await</span> <span class="n">api_session</span><span class="o">.</span><span class="n">users</span><span class="o">.</span><span class="n">get_or_create</span><span class="p">(</span>
        <span class="n">password</span><span class="o">=</span><span class="n">username</span><span class="p">,</span>
        <span class="n">first_name</span><span class="o">=</span><span class="n">first_name</span><span class="p">,</span>
        <span class="n">last_name</span><span class="o">=</span><span class="s1">&#39;User&#39;</span><span class="p">,</span>
        <span class="n">email</span><span class="o">=</span><span class="n">email</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">echo</span><span class="p">(</span><span class="s1">&#39;getting or creating user: &#39;</span><span class="p">,</span> <span class="n">user</span><span class="o">.</span><span class="n">email</span><span class="p">)</span>

    <span class="n">runuser</span> <span class="o">=</span> <span class="n">await</span> <span class="n">api_session</span><span class="o">.</span><span class="n">runusers</span><span class="o">.</span><span class="n">get_or_create</span><span class="p">(</span>
        <span class="n">user</span><span class="o">=</span><span class="n">user</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
        <span class="n">run</span><span class="o">=</span><span class="n">run</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
        <span class="n">defaults</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="bp">None</span><span class="p">}</span>
    <span class="p">)</span>
    <span class="n">echo</span><span class="p">(</span><span class="s1">&#39;getting or creating runuser for user: &#39;</span><span class="p">,</span> <span class="n">user</span><span class="o">.</span><span class="n">email</span><span class="p">)</span>

    <span class="n">await</span> <span class="n">add_runuser_scenario</span><span class="p">(</span><span class="n">runuser</span><span class="p">,</span> <span class="n">api_session</span><span class="p">)</span>


<span class="n">async</span> <span class="k">def</span> <span class="nf">add_runuser_scenario</span><span class="p">(</span><span class="n">runuser</span><span class="p">,</span> <span class="n">api_session</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Add a scenario named &#39;Scenario 1&#39; to the runuser&quot;&quot;&quot;</span>

    <span class="n">scenario</span> <span class="o">=</span> <span class="n">await</span> <span class="n">api_session</span><span class="o">.</span><span class="n">scenarios</span><span class="o">.</span><span class="n">get_or_create</span><span class="p">(</span>
        <span class="n">runuser</span><span class="o">=</span><span class="n">runuser</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
        <span class="n">name</span><span class="o">=</span><span class="s1">&#39;Scenario 1&#39;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">click</span><span class="o">.</span><span class="n">echo</span><span class="p">(</span><span class="s1">&#39;getting or creating runuser {} scenario: {}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
        <span class="n">runuser</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
        <span class="n">scenario</span><span class="o">.</span><span class="n">id</span><span class="p">))</span>

    <span class="n">period</span> <span class="o">=</span> <span class="n">await</span> <span class="n">api_session</span><span class="o">.</span><span class="n">periods</span><span class="o">.</span><span class="n">get_or_create</span><span class="p">(</span>
        <span class="n">scenario</span><span class="o">=</span><span class="n">scenario</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
        <span class="n">order</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">click</span><span class="o">.</span><span class="n">echo</span><span class="p">(</span><span class="s1">&#39;getting or creating runuser {} period 1 for scenario: {}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
        <span class="n">runuser</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
        <span class="n">scenario</span><span class="o">.</span><span class="n">id</span><span class="p">))</span>
</pre></div>


<p>Run your command:</p>
<div class="codehilite"><pre><span></span>$ <span class="nb">export</span> <span class="nv">DJANGO_SETTINGS_MODULE</span><span class="o">=</span>calc_model.settings
$ ./manage.py create_default_env
</pre></div>


<p>Every player's move will be a <code>Decision</code> saved on the current <code>Period</code>. The model will then produce a <code>Result</code> for the
current <code>Period</code>, and the <code>Scenario</code> will step to the next <code>Period</code>.</p>
<p>In your <code>game</code> app module, create a file called <code>runmodel.py</code>.  Next, add <code>save_decision</code> and <code>step_scenario</code> functions to perform these steps:</p>
<div class="codehilite"><pre><span></span><span class="kn">from</span> <span class="nn">modelservice.simpl</span> <span class="kn">import</span> <span class="n">games_client</span>
<span class="kn">from</span> <span class="nn">.model</span> <span class="kn">import</span> <span class="n">Model</span>


<span class="n">async</span> <span class="k">def</span> <span class="nf">save_decision</span><span class="p">(</span><span class="n">period_id</span><span class="p">,</span> <span class="n">decision</span><span class="p">):</span>
    <span class="c1"># add decision to period</span>
    <span class="n">async</span> <span class="k">with</span> <span class="n">games_client</span> <span class="k">as</span> <span class="n">api_session</span><span class="p">:</span>
        <span class="n">decision</span> <span class="o">=</span> <span class="n">await</span> <span class="n">api_session</span><span class="o">.</span><span class="n">decisions</span><span class="o">.</span><span class="n">get_or_create</span><span class="p">(</span>
            <span class="n">period</span><span class="o">=</span><span class="n">period_id</span><span class="p">,</span>
            <span class="n">name</span><span class="o">=</span><span class="s1">&#39;decision&#39;</span><span class="p">,</span>
            <span class="n">data</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;operand&quot;</span><span class="p">:</span> <span class="n">decision</span><span class="p">},</span>
            <span class="n">defaults</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="bp">None</span><span class="p">}</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">decision</span>


<span class="n">async</span> <span class="k">def</span> <span class="nf">step_scenario</span><span class="p">(</span><span class="n">scenario_id</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Step the scenario&#39;s current period</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">async</span> <span class="k">with</span> <span class="n">games_client</span> <span class="k">as</span> <span class="n">api_session</span><span class="p">:</span>
        <span class="n">periods</span> <span class="o">=</span> <span class="n">await</span> <span class="n">api_session</span><span class="o">.</span><span class="n">periods</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">scenario</span><span class="o">=</span><span class="n">scenario_id</span><span class="p">,</span>
                                                   <span class="n">ordering</span><span class="o">=</span><span class="s1">&#39;order&#39;</span><span class="p">)</span>
        <span class="n">period_count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">periods</span><span class="p">)</span>
        <span class="n">period</span> <span class="o">=</span> <span class="n">periods</span><span class="p">[</span><span class="n">period_count</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>

        <span class="n">operand</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="n">period_decisions</span> <span class="o">=</span> <span class="n">await</span> <span class="n">api_session</span><span class="o">.</span><span class="n">decisions</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">period</span><span class="o">=</span><span class="n">period</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">period_decisions</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">operand</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">period_decisions</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;operand&quot;</span><span class="p">])</span>

        <span class="n">prev_total</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="k">if</span> <span class="n">period_count</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">prev_period</span> <span class="o">=</span> <span class="n">periods</span><span class="p">[</span><span class="n">period_count</span> <span class="o">-</span> <span class="mi">2</span><span class="p">]</span>
            <span class="n">prev_period_results</span> <span class="o">=</span> \
                <span class="n">await</span> <span class="n">api_session</span><span class="o">.</span><span class="n">results</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">period</span><span class="o">=</span><span class="n">prev_period</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">prev_period_results</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">prev_total</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">prev_period_results</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;total&quot;</span><span class="p">])</span>

        <span class="c1"># step model</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">Model</span><span class="p">()</span>
        <span class="n">total</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">step</span><span class="p">(</span><span class="n">operand</span><span class="p">,</span> <span class="n">prev_total</span><span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;total&quot;</span><span class="p">:</span> <span class="n">total</span><span class="p">}</span>

        <span class="n">result</span> <span class="o">=</span> <span class="n">await</span> <span class="n">api_session</span><span class="o">.</span><span class="n">results</span><span class="o">.</span><span class="n">get_or_create</span><span class="p">(</span>
            <span class="n">period</span><span class="o">=</span><span class="n">period</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
            <span class="n">name</span><span class="o">=</span><span class="s1">&#39;results&#39;</span><span class="p">,</span>
            <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span>
            <span class="n">defaults</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="bp">None</span><span class="p">}</span>
        <span class="p">)</span>

        <span class="c1"># prepare for next step by adding a new period</span>
        <span class="n">next_period_order</span> <span class="o">=</span> <span class="n">period</span><span class="o">.</span><span class="n">order</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="n">next_period</span> <span class="o">=</span> <span class="n">await</span> <span class="n">api_session</span><span class="o">.</span><span class="n">periods</span><span class="o">.</span><span class="n">get_or_create</span><span class="p">(</span>
            <span class="n">scenario</span><span class="o">=</span><span class="n">scenario_id</span><span class="p">,</span>
            <span class="n">order</span><span class="o">=</span><span class="n">next_period_order</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">await</span> <span class="n">next_period</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">next_period</span><span class="o">.</span><span class="n">id</span>
</pre></div>


<p>In your <code>game</code> app module, create a file called <code>games.py</code> with the following content:</p>
<div class="codehilite"><pre><span></span><span class="kn">from</span> <span class="nn">modelservice.games</span> <span class="kn">import</span> <span class="n">Period</span><span class="p">,</span> <span class="n">Game</span>
<span class="kn">from</span> <span class="nn">modelservice.games</span> <span class="kn">import</span> <span class="n">subscribe</span><span class="p">,</span> <span class="n">register</span>

<span class="kn">from</span> <span class="nn">.runmodel</span> <span class="kn">import</span> <span class="n">step_scenario</span><span class="p">,</span> <span class="n">save_decision</span>


<span class="k">class</span> <span class="nc">CalcPeriod</span><span class="p">(</span><span class="n">Period</span><span class="p">):</span>
    <span class="nd">@subscribe</span>
    <span class="n">async</span> <span class="k">def</span> <span class="nf">submit_decision</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">operand</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Receives the operand played and stores as a ``Decision`` then</span>
<span class="sd">        steps the model saving the ``Result``. A new ``Period`` is added to</span>
<span class="sd">        scenario in preparation for the next decision.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Call will prefix the ROOT_TOPIC</span>
        <span class="c1"># &quot;world.simpl.sims.calc.model.period.1.submit_decision&quot;</span>

        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;submit_decision: Key: {}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">k</span><span class="p">))</span>

        <span class="n">await</span> <span class="n">save_decision</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pk</span><span class="p">,</span> <span class="n">operand</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;submit_decision: saved decision&quot;</span><span class="p">)</span>

        <span class="n">await</span> <span class="n">step_scenario</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scenario</span><span class="o">.</span><span class="n">pk</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;submit_decision: stepped scenario&quot;</span><span class="p">)</span>


<span class="n">Game</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="s1">&#39;calc&#39;</span><span class="p">,</span> <span class="p">[</span>
    <span class="n">CalcPeriod</span><span class="p">,</span>
<span class="p">])</span>
</pre></div>


<p><strong>NOTE:</strong> if you
want to use a filename other than <code>games.py</code> you must ensure the file is imported
somewhere, usually in a <code>__init__.py</code> somewhere for the <code>@game</code> decorator to find
and register your game into the system.</p>
<p>You can start your model service by running:</p>
<div class="codehilite"><pre><span></span>$ <span class="nb">export</span> <span class="nv">DJANGO_SETTINGS_MODULE</span><span class="o">=</span>calc_model.settings
$ ./manage.py run_modelservice
</pre></div>


<p>By default the service will bind to <code>0.0.0.0:8080</code>.</p>
<p>This concludes the tutorial on Model Service. A completed example implementation is available at <code>github.com:simplworld/simpl-calc-model.git</code>
that uses the game slug <code>simpl-calc</code>.</p>
<p>You can now head over to the <a href="../frontend/">Frontend tutorial</a>.</p></div>
        </div>

        <footer class="col-md-12">
            <hr>
            <p>Documentation built with <a href="http://www.mkdocs.org/">MkDocs</a>.</p>
        </footer>
        <script>var base_url = '../../..';</script>
        <script src="../../../js/base.js"></script>
        <script src="../../../search/require.js"></script>
        <script src="../../../search/search.js"></script>

        <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="Search Modal" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                <h4 class="modal-title" id="exampleModalLabel">Search</h4>
            </div>
            <div class="modal-body">
                <p>
                    From here you can search these documents. Enter
                    your search terms below.
                </p>
                <form role="form">
                    <div class="form-group">
                        <input type="text" class="form-control" placeholder="Search..." id="mkdocs-search-query">
                    </div>
                </form>
                <div id="mkdocs-search-results"></div>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div><div class="modal" id="mkdocs_keyboard_modal" tabindex="-1" role="dialog" aria-labelledby="Keyboard Shortcuts Modal" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                <h4 class="modal-title" id="exampleModalLabel">Keyboard Shortcuts</h4>
            </div>
            <div class="modal-body">
              <table class="table">
                <thead>
                  <tr>
                    <th style="width: 20%;">Keys</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td><kbd>?</kbd></td>
                    <td>Open this help</td>
                  </tr>
                  <tr>
                    <td><kbd>&larr;</kbd></td>
                    <td>Previous page</td>
                  </tr>
                  <tr>
                    <td><kbd>&rarr;</kbd></td>
                    <td>Next page</td>
                  </tr>
                  <tr>
                    <td><kbd>s</kbd></td>
                    <td>Search</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>


    </body>
</html>
